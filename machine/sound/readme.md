# Thomson MO5 Sound Implementation for FPGA

This document describes the implementation of sound generation and processing for the Thomson MO5 computer FPGA recreation. The original MO5 used a simple 1-bit sound system controlled by the Motorola 6821 PIA (Peripheral Interface Adapter). This FPGA implementation faithfully recreates this sound system while also adding high-quality audio output through a modern audio codec.

## Original MO5 Sound Architecture

The Thomson MO5 featured an extremely simple sound system:

- 1-bit sound output from PIA Port B bit 0 (PB0)
- No volume control, tone generation, or envelopes in hardware
- All sound effects were generated by software toggling this single bit at precise intervals
- The sound output was directly connected to an internal speaker

Despite these limitations, skilled programmers could create reasonably complex sound effects and even music by rapidly toggling the sound bit at various frequencies and using sophisticated timing techniques.

## FPGA Implementation Overview

The FPGA implementation recreates the original 1-bit sound system and enhances it with high-quality digital-to-analog conversion using the WM8731 audio codec found on the DE1 board. The implementation consists of several components:

1. **Sound Generation** (from `MO5_PIA.vhd`): The sound bit is controlled by PIA Port B bit 0
2. **Sound Processing** (`MO5_SOUND.vhd`): Converts the 1-bit sound to digital audio and interfaces with the audio codec
3. **I2C Controller** (`i2c_controller.vhd`): Handles communication with the WM8731 audio codec
4. **Clock Generation** (`MO5_CLOCK.vhd`): Provides the 48kHz sampling clock for audio processing

## Component Details

### 1. Sound Generation (MO5_PIA.vhd)

The sound bit is generated by the PIA component when the CPU writes to Port B bit 0:

```vhdl
sound <= pb_out(0) when ddrb(0) = '1' else '0';
```

Key implementation details:
- The sound signal is active high, meaning '1' = sound on, '0' = sound off
- The CPU controls this bit by writing to address $A7C0 (or $A7C1 depending on RS0)
- The sound bit is updated at the CPU clock rate (1 MHz in the original MO5)
- Simple tone generation is achieved by toggling this bit at specific intervals using software timing loops

### 2. Sound Processing (MO5_SOUND.vhd)

The `MO5_SOUND` component takes the 1-bit sound signal from the PIA and converts it to a digital audio stream suitable for the WM8731 audio codec:

Key features:
- Samples the incoming 1-bit sound at 48 kHz (using the clock provided by the clock module)
- Converts the 1-bit signal to 16-bit PCM audio:
  * '1' is converted to +16383 (0x3FFF)
  * '0' is converted to -16384 (0xC000)
- Configures the WM8731 codec via I2C interface
- Implements the I2S protocol to send digital audio to the codec
- Generates the necessary clock signals (BCLK, LRCLK, XCK)

The component is synchronized using two primary clocks:
1. System clock (50 MHz) for most processing
2. 48 kHz sampling clock from the clock module for capturing the sound bit state

Implementation details:
- Audio master clock (XCK) is generated by dividing the 50 MHz system clock to create a 12.5 MHz signal
- BCLK (bit clock) runs at a frequency of approximately 3 MHz
- LRCLK (left/right clock) runs at the 48 kHz sampling rate
- 16-bit audio samples are transmitted serially via the DACDAT line
- Both left and right channels receive the same audio data

### 3. I2C Controller (i2c_controller.vhd)

The I2C controller handles communication with the WM8731 audio codec to configure its settings:

Key features:
- Implements the I2C protocol at 400 kHz
- Handles the start, address, data, acknowledge, and stop conditions
- Supports both read and write operations (though only writes are used for codec configuration)

The controller configures the WM8731 with the following settings:
- Reset control (R15): Reset the codec
- Power control (R6): All functions powered up
- Digital audio path control (R4): DAC enabled, no high-pass filter
- Analog audio path control (R8): DAC selected, line inputs muted
- Digital audio interface format (R5): I2S format, 16-bit, master mode
- Sampling control (R7): Normal mode, 48 kHz sampling rate
- Active control (R9): Codec active
- Headphone output (R1, R2): Volume level set to 0x79 (moderate volume)
- Line In (R0): Muted

### 4. Clock Generation for Sound

The 48 kHz clock used for audio sampling is generated by the `MO5_CLOCK` module. This precise clock frequency is a standard sampling rate for digital audio and ensures high-quality sound reproduction. The clock module provides this signal to the sound processing component, where it's used to sample the 1-bit sound input at regular intervals.

## Audio Signal Flow

1. CPU writes to PIA Port B bit 0 to generate the 1-bit sound signal
2. The 1-bit sound signal is sampled at 48 kHz by the `MO5_SOUND` component
3. The sampled signal is converted to 16-bit PCM audio samples
4. Audio samples are transmitted to the WM8731 codec via I2S protocol
5. The WM8731 converts the digital samples to analog audio signals
6. The analog audio is output through the DE1 board's audio jack

## WM8731 Configuration via I2C

The WM8731 audio codec is configured through a sequence of I2C writes. The configuration process follows these steps:

1. Reset the codec to ensure a clean state
2. Configure power settings to enable all necessary components
3. Set up digital and analog audio paths
4. Configure the audio interface format (I2S, 16-bit)
5. Set the sampling rate to 48 kHz
6. Activate the codec
7. Set appropriate volume levels
8. Mute unused inputs

Each configuration register write requires:
1. Sending the 7-bit device address (0x1A) with write bit (0)
2. Sending the register address (high byte)
3. Sending the register data (low byte)

## I2S Protocol Implementation

The I2S (Inter-IC Sound) protocol is used to transmit digital audio data to the WM8731 codec. The implementation follows the standard I2S format:

1. BCLK (Bit Clock): Clocks out individual bits of the audio sample
2. LRCLK (Left/Right Clock): Indicates whether left (low) or right (high) channel data is being transmitted
3. DACDAT (DAC Data): Serial data line carrying the audio samples

The timing follows these rules:
- Data bits are transmitted MSB first
- 16 bits are transmitted for each channel
- Data changes on the falling edge of BCLK
- LRCLK changes one BCLK cycle after the last bit of the previous channel

## Sound Quality Considerations

The original MO5 had very basic sound capabilities, limited to beeps and simple tones. This implementation improves on the original in several ways:

1. **Higher Resolution**: Converting the 1-bit signal to 16-bit PCM provides much cleaner audio output
2. **Better Sampling**: 48 kHz sampling rate ensures high-quality reproduction
3. **Proper Filtering**: The WM8731 includes filtering to reduce aliasing and noise
4. **Volume Control**: The codec provides proper volume control

## Integration with MO5 System

The sound system integrates with the rest of the MO5 emulation through:

1. Connection to the PIA sound bit output
2. Synchronization with the system clock
3. Use of the DE1 board's audio codec interface

## Conclusion

This sound implementation faithfully recreates the original MO5's simple 1-bit sound generation while enhancing it with modern digital audio processing. The result is a system that preserves the character of the original sound while providing higher quality output suitable for modern audio equipment.

The implementation demonstrates how a very basic sound generation method (a single digital output bit) can be effectively converted to high-quality audio through proper sampling, digital-to-analog conversion, and careful timing management.
